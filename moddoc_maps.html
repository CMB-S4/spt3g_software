
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>maps &#8212; SPT3G Software  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="mpi" href="moddoc_mpi.html" />
    <link rel="prev" title="gcp" href="moddoc_gcp.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="moddoc_mpi.html" title="mpi"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="moddoc_gcp.html" title="gcp"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">SPT3G Software  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">maps</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="maps">
<h1>maps<a class="headerlink" href="#maps" title="Permalink to this heading">¶</a></h1>
<p>The maps project defines map projections, along with G3SkyMap subclasses that provide sky maps in those map projections and tools for format/projection conversions of these data types.</p>
<p>In addition, this library contains three pipeline modules (MapBinner, SingleDetectorMapBinner, and SingleDetectorBoresightBinner) to make binned maps from time-ordered data, as well as a module (MapMockObserver) to mock-observe a provided sky map, generating fake time-ordered-data from it corresponding to some stored instrument pointing itinerary. A few other utility pipeline modules (described below) are provided for some map manipulation tasks.</p>
<p>The key data types defined here are:</p>
<dl class="simple">
<dt>HealpixSkyMap</dt><dd><p>Implements Healpix over all or a fraction of the sky, either in nested or ring mode. The underlying sky map data are represented in one of three ways: as a dense 1-D array (full sky), as a locally-dense region surrounded by zeroes (ring mode only), or as a list of non-zero pixels and their values. The second two modes efficiently represent partial-sky maps.</p>
</dd>
<dt>FlatSkyMap</dt><dd><p>Implements a flat-sky map (similar to a 2D numpy array) in any of the supported projections. The stored map is either a dense 2D array, or a locally dense region (a set of neighboring columns containing non-zero values, each of which contains a single contiguous block of non-zero values).</p>
</dd>
</dl>
<section id="map-attributes">
<h2>Map Attributes<a class="headerlink" href="#map-attributes" title="Permalink to this heading">¶</a></h2>
<p>The following attributes are common to all G3SkyMap subclasses:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">coord_ref</span></code></dt><dd><p>The coordinate system on the sky to which each map pixel is referenced, stored as an instance of the <code class="docutils literal notranslate"><span class="pre">MapCoordReference</span></code> enum.  Currently supported coordinate systems are <code class="docutils literal notranslate"><span class="pre">Equatorial</span></code> (FK5 J2000), <code class="docutils literal notranslate"><span class="pre">Galactic</span></code> and <code class="docutils literal notranslate"><span class="pre">Local</span></code> (telescope azimuth and elevation).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pol_type</span></code></dt><dd><p>The Stokes polarization of the map object, which is an instance of the <code class="docutils literal notranslate"><span class="pre">MapPolType</span></code> enum, and can have the value <code class="docutils literal notranslate"><span class="pre">T</span></code>, <code class="docutils literal notranslate"><span class="pre">Q</span></code>, <code class="docutils literal notranslate"><span class="pre">U</span></code> or None.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pol_conv</span></code></dt><dd><p>The polarization convention used to encode the Q and U Stokes orientations relative to the coordinate axes.  This attribute is an instance of the <code class="docutils literal notranslate"><span class="pre">MapPolConv</span></code> enum, which can have the value <code class="docutils literal notranslate"><span class="pre">IAU</span></code>, <code class="docutils literal notranslate"><span class="pre">COSMO</span></code> or None.  Both IAU and COSMO polarization conventions are supported in polarization-aware functions (e.g. <code class="docutils literal notranslate"><span class="pre">FlattenPol</span></code>), but most default to using the IAU convention.  Warnings will be raised when a polarized map is used without a polarization convention set.  Changing the polarization convention between IAU and COSMO on a <code class="docutils literal notranslate"><span class="pre">U</span></code> map results in flipping the sign of all pixels in the map.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">units</span></code></dt><dd><p>The units system in which the map is computed, stored as an instance of the <code class="docutils literal notranslate"><span class="pre">G3TimestreamUnits</span></code> enum, typically <code class="docutils literal notranslate"><span class="pre">Tcmb</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">weighted</span></code></dt><dd><p>A boolean attribute indicating whether the data in the map have been normalized by the inverse of the appropriate Mueller matrix (<code class="docutils literal notranslate"><span class="pre">weighted=False</span></code>) or not (<code class="docutils literal notranslate"><span class="pre">weighted=True</span></code>).  See more information on map weights below.</p>
</dd>
</dl>
</section>
<section id="file-format-conversions">
<h2>File Format Conversions<a class="headerlink" href="#file-format-conversions" title="Permalink to this heading">¶</a></h2>
<p>We support writing maps into FITS files that can be read with other tools (such as DS9), using the <code class="docutils literal notranslate"><span class="pre">fitsio.save_skymap_fits</span></code> function.  FITS files with compatible headers can be read in using the <code class="docutils literal notranslate"><span class="pre">fitsio.load_skymap_fits</span></code> function.</p>
<p>T, Q, U and corresponding G3SkyMapWeights objects are written to a single file as a sequence of HDUs.  FlatSkyMap objects are stored in dense format (see below) to CompImageHDU objects if compression is enabled, and otherwise stored in dense format to standard ImageHDU objects.  The latter can be loaded using “old style” fits readers, such as the <code class="docutils literal notranslate"><span class="pre">idlastro</span></code> fits utilities.</p>
<p>HealpixSkyMap objects are stored in a sequence of BinTableHDU objects, a format that is compatible with the <code class="docutils literal notranslate"><span class="pre">healpy.read_map</span></code> function.  Dense maps (see below) are stored using implicit indexing, and sparse maps are stored using explicit indexing with an additional pixel index column.</p>
</section>
<section id="indexing">
<h2>Indexing<a class="headerlink" href="#indexing" title="Permalink to this heading">¶</a></h2>
<p>Values in maps can be set and retrieved using the standard python (or C++) <code class="docutils literal notranslate"><span class="pre">[]</span></code> operator. Both flat and Healpix maps support a 1-D indexing convention. For flat-sky maps, this 1-D index follows C ordering; for Healpix maps, this is the normal 1-D Healpix pixel number. Flat-sky maps also accept 2-D indices, which have ordering following normal language conventions for 2-D indices ((y, x) in Python, (x, y) in C++).</p>
<p>Note that sky maps <em>do not</em> support numpy-style slicing operations, except for 2-D indexing of flat-sky maps (see below), which makes a copy of the underlying map data.  To perform operations with other numpy arrays, use <code class="docutils literal notranslate"><span class="pre">numpy.asarray</span></code>, which will convert the map to its dense representation (see below) and provides read-write access the map’s internal buffer, which requires no meaningful CPU time or memory.</p>
</section>
<section id="sparsity">
<h2>Sparsity<a class="headerlink" href="#sparsity" title="Permalink to this heading">¶</a></h2>
<p>By default, both Healpix and flat-sky maps are initialized in sparse mode. This imposes a slight performance penalty but will result in the map storing only non-zero portions (with caveats, see details above), substantially reducing RAM usage. Some map operations, in particular casting to numpy arrays, will result in the implicit conversion of the map to dense storage, which can result in sudden increases in RAM usage. The current sparsity mode can be examined or changed with the <code class="docutils literal notranslate"><span class="pre">sparse</span></code> property (flat sky maps) or the <code class="docutils literal notranslate"><span class="pre">dense</span></code>, <code class="docutils literal notranslate"><span class="pre">ringsparse</span></code>, or <code class="docutils literal notranslate"><span class="pre">indexedsparse</span></code> properties (Healpix maps). Serialization to <code class="docutils literal notranslate"><span class="pre">.g3</span></code> files will maintain the current sparsity scheme, as do arithmetic operators where possible. Serialization to <code class="docutils literal notranslate"><span class="pre">.fits</span></code> files implicitly converts flat sky maps to dense mode, but preserves the sparsity of Healpix maps.  The current number of stored pixels can be obtained using the <code class="docutils literal notranslate"><span class="pre">npix_allocated</span></code> property, and the number of non-zero pixels can be obtained using the <code class="docutils literal notranslate"><span class="pre">npix_nonzero</span></code> property.  Dense maps can be efficiently compactified in memory using the <code class="docutils literal notranslate"><span class="pre">G3SkyMap.compact</span></code> method, or the <code class="docutils literal notranslate"><span class="pre">CompactMaps</span></code> pipeline module.</p>
<p>Beyond paying attention to implicit conversions to dense storage and the performance impact of sparse storage (which is small), users of this code do not need to worry about the storage mode–all interfaces are identical in all modes.</p>
</section>
<section id="map-interpolation">
<h2>Map Interpolation<a class="headerlink" href="#map-interpolation" title="Permalink to this heading">¶</a></h2>
<p>Several interpolation and rebinning utilities are provided.  The method <code class="docutils literal notranslate"><span class="pre">G3SkyMap.get_interp_values</span></code> can be used for extracting map values at arbitrary sky positions.  The method <code class="docutils literal notranslate"><span class="pre">G3SkyMap.rebin</span></code> can be used to downgrade the map resolution in a way that preserves the total power within each map pixel.</p>
<p>The functions <code class="docutils literal notranslate"><span class="pre">healpix_to_flatsky</span></code> and <code class="docutils literal notranslate"><span class="pre">flatsky_to_healpix</span></code> functions are provided to reproject maps between flat sky and curved sky systems, with options to use interpolation or rebinning to improve the accuracy of the reprojection.</p>
<p>The more general <code class="docutils literal notranslate"><span class="pre">reproj_map</span></code> function can also be used to convert between flat sky projections.</p>
</section>
<section id="map-weights">
<h2>Map Weights<a class="headerlink" href="#map-weights" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">G3SkyMapWeights</span></code> class combines the six unique components of the Mueller weight matrix into one object.  The individual matrix terms can be accessed using the attributes <code class="docutils literal notranslate"><span class="pre">G3SkyMapWeights.TT</span></code>, etc, or as keyed elements (e.g. <code class="docutils literal notranslate"><span class="pre">weights['TT']</span></code>).  The full matrix for an individual map pixel can be accessed using the standard <code class="docutils literal notranslate"><span class="pre">[]</span></code> operator.  In python, this returns a symmetric 3x3 numpy array that is a copy of the values in the underlying maps, and in C++ this returns a MuellerMatrix object, with scalar attributes <code class="docutils literal notranslate"><span class="pre">MuellerMatrix.tt</span></code>, etc that are writable references to elements of the underlying map objects.  The <code class="docutils literal notranslate"><span class="pre">G3SkyMapWeights.polarized</span></code> attribute determines whether the weight structure contains polarization information.  For unpolarized weights, only the <code class="docutils literal notranslate"><span class="pre">TT</span></code> element is set, and the <code class="docutils literal notranslate"><span class="pre">[]</span></code> operator returns a scalar value in python, and a MuellerMatrix with just the TT element set in C++.</p>
<p>In C++ there is also a StokesVector object that is analogous to the MuellerMatrix object.  It has scalar attributes StokesVector.t etc, that are writable references to elements of map objects.  Matrix operations on the StokesVector and MuellerMatrix objects are well defined.</p>
<p>Weights are removed from or applied to a set of Stokes T/Q/U maps simultaneously, using the <code class="docutils literal notranslate"><span class="pre">remove_weights</span></code> or <code class="docutils literal notranslate"><span class="pre">apply_weights</span></code> functions, or their corresponding pipeline modules.</p>
</section>
<section id="map-frames-and-pipelines">
<h2>Map Frames and Pipelines<a class="headerlink" href="#map-frames-and-pipelines" title="Permalink to this heading">¶</a></h2>
<p>Maps and associated weights are generally stored in memory and on disk in <code class="docutils literal notranslate"><span class="pre">G3Frames</span></code> of type <code class="docutils literal notranslate"><span class="pre">G3FrameType.Map</span></code>, with keys <code class="docutils literal notranslate"><span class="pre">'T',</span> <span class="pre">'Q',</span> <span class="pre">'U',</span> <span class="pre">'Wpol'</span></code> defined for polarized maps, and <code class="docutils literal notranslate"><span class="pre">'T',</span> <span class="pre">'Wunpol'</span></code> defined for unpolarized maps.  Map frames can be checked for validity using the <code class="docutils literal notranslate"><span class="pre">ValidateFrames</span></code> pipeline module, which raises errors or warnings for missing keys or inconsistent attributes.</p>
<p>Map frames can be manipulated in a pipeline using some memory-efficient pipeline modules.  Weights can be applied or removed from their corresponding Stokes maps using the <code class="docutils literal notranslate"><span class="pre">ApplyWeights</span></code> or <code class="docutils literal notranslate"><span class="pre">RemoveWeights</span></code> pipeline modules.  Maps can be converted to polarized or unpolarized versions using the <code class="docutils literal notranslate"><span class="pre">MakeMapPolarized</span></code> and <code class="docutils literal notranslate"><span class="pre">MakeMapUnpolarized</span></code> modules.  They can also be compactified to their most sparse representation using the <code class="docutils literal notranslate"><span class="pre">CompactMaps</span></code> module.</p>
<p>Existing maps can be injected into a pipeline using the <code class="docutils literal notranslate"><span class="pre">InjectMaps</span></code> module, and map stubs can be injected using <code class="docutils literal notranslate"><span class="pre">InjectMapStub</span></code> or <code class="docutils literal notranslate"><span class="pre">ReplicateMaps</span></code>.  Maps can also be extracted from a pipeline using the <code class="docutils literal notranslate"><span class="pre">ExtractMaps</span></code> module.</p>
</section>
<section id="flat-sky-map-projections">
<h2>Flat Sky Map Projections<a class="headerlink" href="#flat-sky-map-projections" title="Permalink to this heading">¶</a></h2>
<p>For flat-sky maps, we support the following map projections:</p>
<dl class="simple">
<dt>ProjSansonFlamsteed</dt><dd><p>Sanson-Flamsteed (also called the sinusoidal projection). It has equal-area pixels, defined by multiplying azimuth distances by cos(latitude). Mercator-esque in that lines of constant latitude are transformed to lines of constant y. Distances are not preserved. Also known as “proj 0”.</p>
</dd>
<dt>ProjPlateCarree</dt><dd><p>The Plate-Carree projection just plots latitude and longitude on a grid: latitude lines are at constant y and equally spaced, while longitude lines are at constant x and equally spaced. Pixels are not equal-area. Also known as “proj 1”.  A variant of this projection, called ProjBICEP (or “proj 9”), adjusts the resolution along x to scale with the cosine of the latitude of the center of the map.</p>
</dd>
<dt>ProjOrthographic</dt><dd><p>The projection of the sphere onto a plane – the sky looks like a circle. Can only show one hemisphere. Lines drawn on the map do not correspond to latitude or longitude. Pixels are not equal-area. Also known as “proj 2”.</p>
</dd>
<dt>ProjStereographic</dt><dd><p>Another projection of the sphere onto a plane that makes it look like a circle. Differs from an orthographic projection in that it lets you see both hemispheres. Popularized in the form of the UN logo. Lines drawn on the map do not correspond to latitude or longitude. Pixels are not equal-area. Also known as “proj 4”.</p>
</dd>
<dt>ProjLambertAzimuthalEqualArea</dt><dd><p>Yet another mapping of the sphere to a circle, but this one has equal-area pixels. Largely distance-preserving, which makes it particularly useful for power-spectrum analyses. Also known as “proj 5”.</p>
</dd>
<dt>ProjGnomonic</dt><dd><p>Another projection of the sphere onto a circle. This one has the property that straight lines correspond to geodesics. Does not have equal-area pixels. Can show less than half a sphere. Also known as a “tangent projection” or “proj 6”.</p>
</dd>
<dt>ProjCylindricalEqualArea</dt><dd><p>The Lambert cylindrical equal-area projection (CEA) maps the sphere to a rectangle. Has equal-area pixels. Lines of constant x correspond to constant longitude; lines of constant y are constant latitude. Latitudes get closer together (by sin(latitude)) at the poles. Also known as “proj 7”.</p>
</dd>
</dl>
</section>
<section id="flat-sky-map-manipulation">
<h2>Flat Sky Map Manipulation<a class="headerlink" href="#flat-sky-map-manipulation" title="Permalink to this heading">¶</a></h2>
<p>Flat sky maps have additional functions defined for efficient manipulation in memory.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">FlattenPol</span></code> pipeline module flattens the Q and U stokes parameters to align with the pixel coordinate grid, which is necessary for computing power spectra in the flat sky approximation.</p>
<p>Small patches can be extracted from and inserted into larger flat sky maps using the <code class="docutils literal notranslate"><span class="pre">FlatSkyMap.extract_patch</span></code> and <code class="docutils literal notranslate"><span class="pre">FlatSkyMap.insert_patch</span></code> methods, respectively.  Also, maps can be padded and cropped using the <code class="docutils literal notranslate"><span class="pre">FlatSkyMap.reshape</span></code> method, which keeps the patch centered in the output map.  All of these preserve the map pixelization and correspondence to angle on the sky.</p>
<p>As an equivalent and more Pythonic alternative, you can also extract portions of the map using numpy-style slicing operations (e.g. <code class="docutils literal notranslate"><span class="pre">map[45:130,114:182]</span></code>), which will produce a map with the same contents as the numpy operation but without converting it to a dense map and with all the coordinate information set appropriately (and is equivalent to <code class="docutils literal notranslate"><span class="pre">extract_patch()</span></code>). This also works with setting, but the coordinates have to match the sub-subcoordinates (as you would have gotten them from getting a slice or <code class="docutils literal notranslate"><span class="pre">extract_patch()</span></code>).  Note that this slicing creates a copy of the underlying data, so in-place operations (e.g. <code class="docutils literal notranslate"><span class="pre">map[45:130,114:182]</span> <span class="pre">+=</span> <span class="pre">5</span></code>) will work, but are not necessarily memory efficient.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">maps</a><ul>
<li><a class="reference internal" href="#map-attributes">Map Attributes</a></li>
<li><a class="reference internal" href="#file-format-conversions">File Format Conversions</a></li>
<li><a class="reference internal" href="#indexing">Indexing</a></li>
<li><a class="reference internal" href="#sparsity">Sparsity</a></li>
<li><a class="reference internal" href="#map-interpolation">Map Interpolation</a></li>
<li><a class="reference internal" href="#map-weights">Map Weights</a></li>
<li><a class="reference internal" href="#map-frames-and-pipelines">Map Frames and Pipelines</a></li>
<li><a class="reference internal" href="#flat-sky-map-projections">Flat Sky Map Projections</a></li>
<li><a class="reference internal" href="#flat-sky-map-manipulation">Flat Sky Map Manipulation</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="moddoc_gcp.html"
                          title="previous chapter">gcp</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="moddoc_mpi.html"
                          title="next chapter">mpi</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/moddoc_maps.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="moddoc_mpi.html" title="mpi"
             >next</a> |</li>
        <li class="right" >
          <a href="moddoc_gcp.html" title="gcp"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">SPT3G Software  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">maps</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.1.1.
    </div>
  </body>
</html>