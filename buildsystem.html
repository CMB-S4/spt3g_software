<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Build System &#8212; SPT3G Software  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css?v=279e0f84" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Style Guide" href="styleguide.html" />
    <link rel="prev" title="Auto-documentation" href="autodoc.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="styleguide.html" title="Style Guide"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="autodoc.html" title="Auto-documentation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">SPT3G Software  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Build System</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="build-system">
<h1>Build System<a class="headerlink" href="#build-system" title="Link to this heading">¶</a></h1>
<section id="cmake-overview">
<h2>CMake Overview<a class="headerlink" href="#cmake-overview" title="Link to this heading">¶</a></h2>
<p>We use cmake as a build system, which provides a number of nice features for finding dependencies and managing the build process. cmake generates Makefiles (or XCode projects) from files called <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> in each directory. cmake in general is designed to perform so-called “out-of-tree” builds, which keep the source directories unmodified by object files. The process for doing this is something like this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>build
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/CMB-S4/spt3g_software<span class="w"> </span>src
<span class="nb">cd</span><span class="w"> </span>build
cmake<span class="w"> </span>../src
make
</pre></div>
</div>
<p>A number of variables can be set on the command line when cmake is run that control the build. The syntax for these options is <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">-DVARIABLE=value</span> <span class="pre">srcdir</span></code>.</p>
<blockquote>
<div><dl class="simple">
<dt>CMAKE_BUILD_TYPE</dt><dd><p>This can be set to either <code class="docutils literal notranslate"><span class="pre">Release</span></code> or <code class="docutils literal notranslate"><span class="pre">Debug</span></code>. Setting it to <code class="docutils literal notranslate"><span class="pre">Release</span></code> will cause the compiler to optimize the code more, making it substantially faster at the expense of increased build times and removal of some debugging information.</p>
</dd>
<dt>BUILD_PROJECTS</dt><dd><p>This variable can be set to a semicolon-separated list of projects to build, to allow building only a subset of the projects which are present. For example, specifying <code class="docutils literal notranslate"><span class="pre">-DBUILD_PROJECTS='gcp;dfmux'</span></code> will result in the <code class="docutils literal notranslate"><span class="pre">core</span></code>, <code class="docutils literal notranslate"><span class="pre">gcp</span></code>, and <code class="docutils literal notranslate"><span class="pre">dfmux</span></code> projects being built. The <code class="docutils literal notranslate"><span class="pre">core</span></code> project must always be built, so if this variable is set to a list which does not contain it, it will be added. Other project dependencies are not automatically detected, so use this feature only if you are certain that you understand exactly which projects you need. Note that the list will usually need to be quoted to avoid the shell interpreting the first semicolon as the end of the command.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="adding-a-project">
<h2>Adding a Project<a class="headerlink" href="#adding-a-project" title="Link to this heading">¶</a></h2>
<p>To add another project to the repository (corresponding to a python module, e.g. <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">spt3g</span> <span class="pre">import</span> <span class="pre">newthing</span></code>), make a new directory at the root of the repository. This directory must contain a file called CMakeLists.txt.</p>
<section id="adding-python-code">
<h3>Adding Python code<a class="headerlink" href="#adding-python-code" title="Link to this heading">¶</a></h3>
<p>To include Python code, include a line like the following in your CMakeLists.txt:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">execute_process</span><span class="p">(</span><span class="s">COMMAND</span><span class="w"> </span><span class="s">ln</span><span class="w"> </span><span class="s">-fsn</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="o">}</span><span class="s">/python</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_LIBRARY_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/newthing</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">newthing</span></code> is the name of your project (which <strong>must</strong> match the directory name) and <code class="docutils literal notranslate"><span class="pre">python</span></code> is the name of the directory inside your project containing the Python source code. If your project contains only Python code, this need not be a subdirectory and you can remove the “/python”.</p>
</section>
<section id="adding-a-c-library">
<h3>Adding a C++ library<a class="headerlink" href="#adding-a-c-library" title="Link to this heading">¶</a></h3>
<p>To add a C++ component to your project, add some lines like the following:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_library</span><span class="p">(</span><span class="s">newthing</span><span class="w"> </span><span class="s">SHARED</span>
<span class="w">        </span><span class="s">src/MyNewThing.cxx</span><span class="w"> </span><span class="s">src/python.cxx</span>
<span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">newthing</span><span class="w"> </span><span class="s">core</span><span class="w"> </span><span class="o">${</span><span class="nv">Boost_LIBRARIES</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">PYTHON_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
</pre></div>
</div>
<p>This builds a library called <code class="docutils literal notranslate"><span class="pre">newthing.so</span></code> from the two given source files and links it to the spt3g core library and the Boost and Python libraries (which are mandatory). Typically C++ source files are in a directory called <code class="docutils literal notranslate"><span class="pre">src</span></code>. Header files that you want visible from other projects must be placed in a directory called <code class="docutils literal notranslate"><span class="pre">include/newthing</span></code>.</p>
<p>Every C++ library must contain a file declaring the library to Python. This file is usually named <code class="docutils literal notranslate"><span class="pre">python.cxx</span></code> and has contents like the following:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G3Frame.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pybindings.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/python.hpp&gt;</span>

<span class="n">SPT3G_PYTHON_MODULE</span><span class="p">(</span><span class="n">newthing</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="n">boost</span><span class="o">::</span><span class="n">python</span><span class="o">::</span><span class="k">import</span><span class="p">(</span><span class="s">&quot;spt3g.core&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Import core python bindings</span>

<span class="w">        </span><span class="n">G3ModuleRegistrator</span><span class="o">::</span><span class="n">CallRegistrarsFor</span><span class="p">(</span><span class="s">&quot;newthing&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is sufficient for most uses (with “newthing” replaced by the name of the project).</p>
</section>
<section id="adding-a-c-executable">
<h3>Adding a C++ executable<a class="headerlink" href="#adding-a-c-executable" title="Link to this heading">¶</a></h3>
<p>You can also add C++ executables. Usually, there is not much reason to do this since everything is designed to be interacted with by Python. A few projects contain small standalone executables nonetheless, typically as test programs.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_executable</span><span class="p">(</span><span class="s">newthingexec</span><span class="w"> </span><span class="s">MyNewThingExecutable.cxx</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">newthingexec</span><span class="w"> </span><span class="s">core</span><span class="w"> </span><span class="s">newthing</span><span class="p">)</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">SPT3G_PROGRAMS</span><span class="w"> </span><span class="s">newthingexec</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">SPT3G_PROGRAMS</span><span class="w"> </span><span class="o">${</span><span class="nv">SPT3G_PROGRAMS</span><span class="o">}</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">target_link_libraries</span></code> command works as in <a class="reference internal" href="#adding-a-c-library">Adding a C++ library</a> above. The first command produces an executable named <code class="docutils literal notranslate"><span class="pre">newthingexec</span></code> that will be placed in the <code class="docutils literal notranslate"><span class="pre">bin</span></code> subdirectory of the build directory. The <code class="docutils literal notranslate"><span class="pre">list</span></code> and <code class="docutils literal notranslate"><span class="pre">set</span></code> commands inform other parts of the build system that this executable will exist, so that it can be included during installation.</p>
</section>
<section id="adding-tests">
<h3>Adding tests<a class="headerlink" href="#adding-tests" title="Link to this heading">¶</a></h3>
<p>Tests can be written in either Python or C++. Some tests must be written in one language  in order to test interfaces specific to it; otherwise, most tests are currently written in python.</p>
<p>The simplest way to run the full set of tests is by executing <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>. This does not allow for much flexibility, however, so in cases where more control is desirable, one should run tests using the <code class="docutils literal notranslate"><span class="pre">ctest</span></code> driver tool directly. Commonly useful options are <code class="docutils literal notranslate"><span class="pre">ctest</span> <span class="pre">--output-on-failure</span></code> which will show a test’s output when it fails, which is frequently useful for understanding what the failure was in order to fix it, and <code class="docutils literal notranslate"><span class="pre">ctest</span> <span class="pre">-R</span> <span class="pre">&lt;regex&gt;</span></code> which will run any tests any part of whose name is matches the given regular expression, which is handy for running just a particular test to debug it, without having to wait while the entire test suite runs each time.</p>
<section id="python-tests">
<h4>Python Tests<a class="headerlink" href="#python-tests" title="Link to this heading">¶</a></h4>
<p>Python tests should be placed in a <code class="docutils literal notranslate"><span class="pre">tests</span></code> subdirectory of the project. Each test must then also be declared in the project’s <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>, so that <code class="docutils literal notranslate"><span class="pre">cmake</span></code> will know to include it in the list of tests to be run by <code class="docutils literal notranslate"><span class="pre">ctest</span></code> or the <code class="docutils literal notranslate"><span class="pre">test</span></code> build target. This is done by using the <code class="docutils literal notranslate"><span class="pre">add_spt3g_test</span></code> macro:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_spt3g_test</span><span class="p">(</span><span class="s">test_foo</span><span class="p">)</span>
</pre></div>
</div>
<p>will add a test which is implemented in <code class="docutils literal notranslate"><span class="pre">tests/test_foo.py</span></code>.</p>
<p>The contents of a Python test script can be anything; the script is simply run, and if its exit value is 0, it is considered to have passed. Any non-zero exit status will be taken to indicate a failure. The simplest mechanism to do tests is to just write code with <code class="docutils literal notranslate"><span class="pre">assert</span></code> statements which check that properties of interest hold.</p>
</section>
<section id="c-tests">
<h4>C++ Tests<a class="headerlink" href="#c-tests" title="Link to this heading">¶</a></h4>
<p>C++ tests consist of one or more implementation files which declare tests, organized into test groups. The implementation files for a test are linked together into a test executable.</p>
<p>Like Python tests, C++ tests must be declared in the project’s CMake script, which is done using the <code class="docutils literal notranslate"><span class="pre">add_spt3g_test_program</span></code> command:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_spt3g_test_program</span><span class="p">(</span><span class="s">test</span>
<span class="w">                       </span><span class="s">SOURCE_FILES</span>
<span class="w">                         </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/my_test.cpp</span>
<span class="w">                       </span><span class="s">USE_PROJECTS</span><span class="w"> </span><span class="s">core</span><span class="p">)</span>
</pre></div>
</div>
<p>The first argument is the name of the test executable, which will be prefixed with the project name. Several implementation files may be listed after <code class="docutils literal notranslate"><span class="pre">SOURCE_FILES</span></code>, and the arguments after <code class="docutils literal notranslate"><span class="pre">USE_PROJECTS</span></code> indicate which projects the executable depends on, so suitable compiler options will be generated to give access to those projects’ header paths and to link against their libraries.
Arbitrary labels can also be associated with a test by passing them after the <code class="docutils literal notranslate"><span class="pre">TEST_LABELS</span></code> argument.</p>
<p>Typically, each implementation file defines one test group, but multiple implementation files may redeclare and contribute to the same test group. It is also possible to place multiple test groups in one translation unit by isolating each in its own namespace. Each test implementation file should include the <code class="docutils literal notranslate"><span class="pre">G3Test.h</span></code> header to have access to the test infrastructure definitions.</p>
<p>A test group is declared using the <code class="docutils literal notranslate"><span class="pre">TEST_GROUP</span></code> macro:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_GROUP</span><span class="p">(</span><span class="n">MyTests</span><span class="p">)</span>
</pre></div>
</div>
<p>Individual tests are then defined using the <code class="docutils literal notranslate"><span class="pre">TEST</span></code> macro, followed by a function body which does the work of the test:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">TEST</span><span class="p">(</span><span class="n">Test1</span><span class="p">){</span>
<span class="w">        </span><span class="n">Num</span><span class="o">::</span><span class="n">InitializeNumbers</span><span class="p">();</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">n5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Num</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">n7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Num</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
<span class="w">        </span><span class="n">ENSURE</span><span class="p">(</span><span class="n">n5</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n7</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;5 should be less than 7&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The argument to the <code class="docutils literal notranslate"><span class="pre">TEST</span></code> macro is the name of the test, which will then have a fully qualified name derived from its test group: <code class="docutils literal notranslate"><span class="pre">MyTests::Test1</span></code>.</p>
<p>Since multiple C++ tests can run in the same executable, it is poor form to use <code class="docutils literal notranslate"><span class="pre">assert</span></code>, <code class="docutils literal notranslate"><span class="pre">exit</span></code>, or some other mechanism which can stop the whole process before other tests can run. Tests indicate failure by throwing an exception, but for convenience and readability, particularly of failure messages, a set of macros are provided. The simpest is <code class="docutils literal notranslate"><span class="pre">ENSURE</span></code>, which takes a predicate to be tested, and optionally a message to be shown if the predicate evaluates to false. An example is shown above, and if that test fails, the output produced would look similar to the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>MyTests::Test1: /some/path/my_test.cpp:50: n5 &lt; n7: 5 should be less than 7
FAIL
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">FAIL</span></code> macro can be used when a test has reached a point in its control flow which indicates failure without any further condition needing to be checked. This is particularly useful for ensuring that exceptions are or aren’t thrown in correct places:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">TEST</span><span class="p">(</span><span class="n">Exceptions</span><span class="p">){</span>
<span class="w">        </span><span class="k">try</span><span class="p">{</span>
<span class="w">                </span><span class="n">some_func</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">catch</span><span class="p">(...){</span>
<span class="w">                </span><span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;some_func must not throw exceptions&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">try</span><span class="p">{</span>
<span class="w">                </span><span class="n">other_func</span><span class="p">(</span><span class="n">bad_val</span><span class="p">);</span>
<span class="w">                </span><span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;other_func must throw an exception when passed bad_val&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">catch</span><span class="p">(...){}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is also the <code class="docutils literal notranslate"><span class="pre">ENSURE_EQUAL</span></code> macro, which specifically checks to expressions for equality, and produces a detailed error message if they are not:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">TEST</span><span class="p">(</span><span class="n">Equality</span><span class="p">){</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="w">        </span><span class="n">ENSURE_EQUAL</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="s">&quot;a and b should be the same&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>MyTests::Equality: my_test.cpp:19: ENSURE_EQUAL(a, b): 4 != 5: a and b should be the same
</pre></div>
</div>
</section>
</section>
</section>
<section id="mixing-c-and-python">
<h2>Mixing C++ and Python<a class="headerlink" href="#mixing-c-and-python" title="Link to this heading">¶</a></h2>
<p>If your project has both a C++ and a Python component, place the following into your <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">spt3g.core.load_pybindings</span> <span class="kn">import</span> <span class="n">load_pybindings</span>
<span class="n">load_pybindings</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">__path__</span><span class="p">)</span>
</pre></div>
</div>
<p>This (with no modifications) will merge the C++ and Python parts of the module into a single Python namespace.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Build System</a><ul>
<li><a class="reference internal" href="#cmake-overview">CMake Overview</a></li>
<li><a class="reference internal" href="#adding-a-project">Adding a Project</a><ul>
<li><a class="reference internal" href="#adding-python-code">Adding Python code</a></li>
<li><a class="reference internal" href="#adding-a-c-library">Adding a C++ library</a></li>
<li><a class="reference internal" href="#adding-a-c-executable">Adding a C++ executable</a></li>
<li><a class="reference internal" href="#adding-tests">Adding tests</a><ul>
<li><a class="reference internal" href="#python-tests">Python Tests</a></li>
<li><a class="reference internal" href="#c-tests">C++ Tests</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#mixing-c-and-python">Mixing C++ and Python</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="autodoc.html"
                          title="previous chapter">Auto-documentation</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="styleguide.html"
                          title="next chapter">Style Guide</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/buildsystem.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="styleguide.html" title="Style Guide"
             >next</a> |</li>
        <li class="right" >
          <a href="autodoc.html" title="Auto-documentation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">SPT3G Software  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Build System</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright .
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>